<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACTRA360 PARTS ENTRY FORM</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .header-section { background-color: #f8f9fa; border-bottom: 2px solid #ddd; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .sheet-container { background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 750px; margin: 0 auto; border-radius: 8px; overflow: hidden; }
        table { border-collapse: collapse; width: 100%; }
        td { border: 1px solid #dfe3e8; padding: 12px; font-size: 14px; }
        
        /* Excel Style Alternating Colors */
        .row-odd .label-cell { background-color: #FFD700 !important; color: #000 !important; font-weight: bold; width: 40%; }
        .row-even .label-cell { background-color: #555555 !important; color: #ffffff !important; font-weight: bold; width: 40%; }
        
        .part-block { border: 2px solid #15222F; margin: 15px; border-radius: 6px; background: #fff; position: relative; }
        .part-header { background: #15222F; color: #00FF7F; padding: 8px; font-weight: bold; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none; }
        button { padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-submit { background-color: #28a745; color: white; width: 100%; margin-top: 20px; }
        .btn-add { background-color: #007bff; color: white; width: 100%; margin: 10px 0; }
        .status-tag { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .locked { background: #f8d7da; color: #721c24; }
        .unlocked { background: #d4edda; color: #155724; }
        .required-star { color: #dc3545; }
    </style>
</head>
<body>

<div class="header-section">
    <div style="display: flex; align-items: center; gap: 30px;">
        <img src="pactra new .jpg" alt="Pactra 360" style="height: 55px;" onerror="this.src='Picture1.png'">
        <h2 style="margin: 0; color: #333; font-family: sans-serif;">PACTRA360 PARTS ENTRY FORM</h2>
        <img src="Picture1.png" alt="Epiroc Logo" style="height: 55px;">
    </div>
</div>

<form id="consumptionForm">
    <div class="sheet-container">
        <table>
            <tr class="row-odd"><td class="label-cell">Customer Name *</td><td><select id="customerSelect" name="Customer_Name" onchange="updateSites(); checkValidation();" required><option value="">-- Select Customer --</option></select></td></tr>
            <tr class="row-even"><td class="label-cell">Date *</td><td><input type="date" name="Entry_Date" id="valDate" oninput="checkValidation()" required></td></tr>
            <tr class="row-odd"><td class="label-cell">User Name *</td><td><input type="text" name="Technician_Name" id="valTech" placeholder="e.g. tech_id" required></td></tr>
            <tr class="row-even"><td class="label-cell" style="background-color: #fff3cd !important; color:#000 !important;">Site Access Password *</td><td><input type="password" id="passInput" required></td></tr>
            <tr>
                <td colspan="2" style="text-align: center; padding: 15px;">
                    <button type="button" id="verifyBtn" onclick="verifyCredentials()" style="background: #007bff; color: white; width: 80%;">Verify & Unlock Form</button>
                    <div id="loginStatus" style="margin-top: 10px;"><span id="statusLabel" class="status-tag locked">Locked - Please Verify</span></div>
                </td>
            </tr>

            <tbody id="protectedContent" class="hidden">
                <tr class="row-odd"><td class="label-cell">Work Site *</td><td><select id="workSiteSelect" name="Work_Site" onchange="updateFleet(); checkValidation();"><option value="">-- Select Site --</option></select></td></tr>
                <tr class="row-even"><td class="label-cell">Fleet ID *</td><td><select id="fleetSelect" name="Fleet_ID" onchange="checkValidation()"><option value="">-- Select Fleet --</option></select></td></tr>
                <tr class="row-odd"><td class="label-cell">Engine Hours *</td><td><input type="number" name="Engine_Hours" id="valHours" oninput="checkValidation()" required></td></tr>
                <tr class="row-even"><td class="label-cell">Remarks</td><td><textarea name="Remarks" rows="2"></textarea></td></tr>
                <tr>
    <td colspan="2">
       <div class="bulk-section" style="margin-top: 25px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
    <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px;">Bulk Upload Tools</h3>
    
    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
        
        <div style="background: #fff; padding: 10px; border-radius: 5px; border-left: 4px solid #6c757d;">
            <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #555;"><strong>Step 1:</strong> Select Customer, Site, and Fleet above first, then:</p>
            <button type="button" onclick="generateDynamicTemplate()" style="width: 100%; background-color: #6c757d; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                üì• Download Pre-filled Template
            </button>
        </div>

        <div style="background: #fff; padding: 10px; border-radius: 5px; border-left: 4px solid #007bff;">
            <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #555;"><strong>Step 2:</strong> Fill the file and upload here:</p>
            <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 12px; width: 100%; font-size: 0.85em;">
            
            <button type="button" onclick="handleBulkUpload()" style="width: 100%; background-color: #007bff; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                üöÄ Upload & Process Bulk Data
            </button>
        </div>
        
    </div>
</div>

<tr><td colspan="2" id="partsContainer">
                <tr><td colspan="2" id="partsContainer">
                    <div class="part-block" id="part-row-1">
                        <div class="part-header">PART ENTRY #1</div>
                        <table style="width:100%; border:none;">
                            <tr class="row-odd">
                                <td class="label-cell">Part Group *</td>
                                <td><select name="part_group[]" class="group-sel" onchange="updateRowCascades(this); checkValidation();" required>
                                    <option value="">-- Select Group --</option>
                                    <option value="Lubricant">Lubricant</option>
                                    <option value="Parts">Parts</option>
                                    <option value="RockTool">RockTool</option>
                                    <option value="Hoses">Hoses</option>
                                    <option value="UD Parts">UD Parts</option>
                                </select></td>
                            </tr>
                            <tr class="row-even">
                                <td class="label-cell">Part Type *</td>
                                <td><select name="part_type[]" class="type-sel" onchange="updateRowDesc(this); checkValidation();" required><option value="">-- Select Type --</option></select></td>
                            </tr>
                            <tr class="row-odd">
                                <td class="label-cell">Part Description *</td>
                                <td><select name="part_desc[]" class="desc-sel" onchange="checkValidation()" required><option value="">-- Select Description --</option></select></td>
                            </tr>
                            <tr class="row-even">
                                <td class="label-cell">Reason for Replacement *</td>
                                <td><select name="reason[]" class="reason-sel" onchange="checkValidation()" required><option value="">-- Select Reason --</option></select></td>
                            </tr>
                            <tr class="row-odd">
                                <td class="label-cell">Part Number</td>
                                <td><input type="text" name="part_no[]" placeholder="e.g. 558000XXXX"></td>
                            </tr>
                            <tr class="row-even">
                                <td class="label-cell">Quantity *</td>
                                <td><input type="number" name="qty[]" value="1" min="1" oninput="checkValidation()" required></td>
                            </tr>
                            <tr class="row-odd">
                                <td class="label-cell">Price</td>
                                <td><input type="number" step="any" name="unit_price[]" placeholder="0.00"></td>
                            </tr>
                        </table>
                    </div>
                </td></tr>
                
                <tr><td colspan="2" style="text-align: center;">
                    <button type="button" class="btn-add" onclick="addPartLine()">+ Add Another Part Line (Max 10)</button>
                </td></tr>
            </tbody>
        </table>

        <div id="formButtons" class="hidden" style="padding: 20px;">
            <button type="submit" id="submitBtn" class="btn-submit" disabled>Submit All Records to Part_Db</button>
            <button type="button" onclick="location.reload()" style="background:#dc3545; color:white; width:100%; margin-top:10px;">Sign Out / Clear Form</button>
        </div>
    </div>
</form>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbybrxbdpNrjPIS6FpjtzQXrUNSokE2yWwmZ0sBaqKyCmOOLeWQSxCAVCN2i_UGtWTLq/exec";

    const customerToSites = {
        "TATA STEEL LTD": ["Noamundi Iron Ore Mines", "Khondbond Iron Ore Mines", "TSL West Bokaro Q-SE", "TSL West Bokaro Q-AB", "Joda Iron Ore Mines", "TSL Khandband"],
        "ULTRATECH CEMENT LIMITED": ["Manikgarh Cement Works", "Awarpur Cement Works", "Kukurdih Cement Works", "Kotputli Cement Works", "Nathwara Cement Works", "UTCL Bela", "UTCL Rewan", "UTCL Maihar", "Rajshree Cements", "Tadipatri Cement Works"],
        "ADANI CEMENTS LTD": ["ACC Kymore Cement Works", "ACC Gagal Cement Works", "Ambuja Darlaghat Cement Works", "Ambuja Cement Ltd. Rabriyawas", "ACC Wadi"],
        "ADANI ENTERPRISES": ["Adani Coalfields Parsa", "Parsa Kenta Coal Mines"],
        "NMDC LIMITED": ["NMDC Donimalai", "NMDC Bacheli", "NMDC Kirandul", "NMDC Panna"],
        "MEGHA ENGINEERING AND INFRASTRUCTURE": ["Megha - PKG 8B", "Megha Ratle (J&K)"],
        "MAX INFRA": ["Max Infra - PKG 1","Max Bilaspur"],
        "NAVYUGA ENGINEERING CO. LTD.": ["Navyuga - PKG 3"],
        "PATEL ENGINEERING LTD.": ["Patel Engineering Ltd - Kawar"],
        "JSW LTD": ["Nuagaon Iron Ore Mines", "Narayanposhi Iron Ore Mines", "Jajang Iron Ore Mines"],
        "SMS LIMITED": ["SMS Thumlapalli"],
        "DILIP BUILDCON LTD": ["DBL Coal - Siarmal"],
        "SUSHEE INFRA & MINING LIMITED": ["Sushee Infra - SIML Dimapur"],
        "LAFARGE UM UM MINING PRIVATE LTD": ["Lafarge Umiam Mining, Sheila"],
        "CDCL KHOLONGCHU HEP": ["UGEN EARTHMOVERS - CDCL"],
        "GANPATI METAL MINING": ["MOIL"]
    };

    // 2. FULL SITE TO FLEET MAPPING (EXACT COLUMN 3 VALUES)
const siteToFleet = {
    "Noamundi Iron Ore Mines": ["SRD65_2K005_TSLNIM", "SRD65_2K006_TSLNIM", "SRD65_2K008_TSLNIM", "SRD65_24010_TSLNIM", "SRD65_2K011_TSLNIM", "SRD65_2K012_TSLNIM"],
    "Joda Iron Ore Mines": ["SRD65_2K009_TSLNIM", "SRD65_2K010_TSLJIM"],
    "Khondbond Iron Ore Mines": ["SRD65_2K007_TSLNIM", "IDM45_063_TSLKM", "IDM45_064_TSLKM", "ROCL8_083_TSLKIM"], // Fixed hyphen/bracket error here
    "TSL West Bokaro Q-SE": ["SRD65_DM10_TSLWB", "SRD65_DM14_TSLWB", "SRD65_DM15_TSLWB"],
    "TSL West Bokaro Q-AB": ["SRD65_2K10_TSLWB", "SRD65_2K11_TSLWB"],
    "Ambuja Cement Ltd. Rabriyawas": ["FRD50_090_AMBUJA_RBW", "FRD50_659_AMBUJA_RBW"],
    "Megha - PKG 8B": ["L2SMART_056_MEGHA8B", "L2SMART_031_MEGHA8B", "L2SMART_043_MEGHA8B", "BOOMERE2_198_MEGHA8B", "BOOMERE2_216_MEGHA8B", "10HR_481_MEGHA8B", "10HR_443_MEGHA8B", "10HR_482_MEGHA8B", "UNIGROUTSM2_112_MEGHA8B", "UNIGROUTSM2_111_MEGHA8B", "UNIGROUTSM2_370_MEGHA8B"],
     "Megha Ratle (J&K)": ["BOOMERL2_002_RATLE", "BOOMERL2D_013_RATLE", "BOOMERE2C_033_RATLE", "BOOMERE2C_371_RATLE", "BOOMERE2C_030_RATLE"],
    "Max Bilaspur": ["BOOMER2C_175_BILASPUR", "L2SMART_009_BILASPUR", "BOOMERL2D_062_BILASPUR", "BOOMERL2D_151_BILASPUR", "BOOMERL2D_152_BILASPUR", "BOOMERL2D_035_BILASPUR", "BOOMERL2D_038_BILASPUR", "10HR_092_BILASPUR", "10HR_261_BILASPUR", "10HR_409_BILASPUR"],
    "Navyuga - PKG 3": ["BOOMERL2_035_NEC3", "BOOMERL2_038_NEC3", "10HR _250_NEC3", "10HR _350_NEC3", "10HR _267_NEC3"],
    "Max Infra - PKG 1": ["10HR_291_MAX1", "10HR_097_MAX1", "10HR_205_MAX1", "UNIGROUTSM2_360_MAX1", "UNIGROUTSM2_363_MAX1","UNIGROUTSM2_368_MAX1","BOOMERL2_005_MAX1"],
    "SMS Thumlapalli": ["MT2200_17_SMSTMPL", "MT2200_18_SMSTMPL", "MT2200_19_SMSTMPL", "MT2200_20_SMSTMPL", "MT2200_21_SMSTMPL", "MT2200_22_SMSTMPL", "MT2200_23_SMSTMPL", "MT2200_24_SMSTMPL", "MT2200_25_SMSTMPL", "MT2200_26_SMSTMPL", "MT2200_27_SMSTMPL", "MT2200_28_SMSTMPL", "MT2200_29_SMSTMPL", "ST1030_16_SMSTMPL", "ST1030_17_SMSTMPL"],
    "NMDC Bacheli": ["SRT45_001_BACHELI", "SRT45_003_BACHELI", "SRT45_004_BACHELI"],
    "NMDC Kirandul": ["SRT45_002_KIRANDUL", "SRT45_005_KIRANDUL"],
    "Jajang Iron Ore Mines": ["JajangD65I", "JajangD65II"],
    "Narayanposhi Iron Ore Mines": ["SRT45_341_JSW", "SRT45_344_JSW"],
    "Nuagaon Iron Ore Mines": ["SRT45_348_JSW"],
    "Patel Engineering Ltd - Kawar": ["L2D_EM6276_PATEL", "L2D_EM6454_PATEL", "L2D_EM6869_PATEL", "L2D_EM6614_PATEL"],
    "ACC Wadi": ["FRD50_432_ACCWADI", "SRD50_134_ACCWADI"],
    "Manikgarh Cement Works": ["SRT40_126_UTCLMANIK"],
    "Awarpur Cement Works": ["FRD50_376_UTCLAWAR"],
    "Kukurdih Cement Works": ["SRT45_481_UTCLKUKURDI"],
    "Kotputli Cement Works": ["SRT40_191_UTCLKOTPUTLI", "SRT40_525_UTCLKOTPUTLI", "SRT40_632_UTCLKOTPUTLI"],
    "Nathwara Cement Works": ["SRT40_701_UTCLNATH", "SRT40_583_UTCLNATH"],
    "UTCL Bela": ["IBH10_147_UTCLBELA", "FRD50_311_UTCLBELA"],
    "UTCL Rawan": ["FRD50_635_UTCLRAWAN"],
    "UTCL Maihar": ["SRT40_803_UTCLMAIHAR"],
    "Tadipatri Cement Works": ["SRT45_651_UTCLTADIPATRI"],
    "Ambuja Darlaghat": ["SRT40_077_AMBUJADARLA"],
    "DBL Coal - Siarmal": ["D65_DBL_SIARMAL"],
    "Sushee Infra - SIML Dimapur": ["BOOMERL2_033_SUSHEE", "BOOMERL2_029_SUSHEE", "BOOMERL2_036_SUSHEE", "BOOMERL2_001_SUSHEE"],
    "UGEN EARTHMOVERS - CDCL": ["BOOMERL2D_023_CDCL", "BOOMERL2D_030_CDCL"],
    "Lafarge Umiam Mining, Sheila": ["FRD60_337_LAFARGE", "SRT40_526_LAFARGE", "ICM260_071_LAFARGE", "ICM260_076_LAFARGE"],
    "MOIL": ["SRT40_GANPATI"]
};

        const partsData = {
    "Lubricant": { 
        "Hydraulic-Oil": ["Epiroc H300", "VG46 Premium", "High Temp Hydraulic Oil"], 
        "Compressor-Oil": ["Par Oil M", "Par Oil S", "Par Oil S Extreme","Corena S4 R68","Screw Lube"], 
        "Engine_Oil": ["CAT Deo", "HP15W40", "Volvoline 15W40"],
        "Lube-Oil": ["RockOil", "Cop-Oil", "Servonium100"],
        "Gear-Oil": ["HP-90", "EP-90", "80W140","SAE30","80W90"],
        "Other-Lube": ["EP2 Grease", "MP Grease", "Thread Grease","ELC Coolant","Core Wrap","Torqueless","Cop-Grease"]
    },
    "Parts": { 
        "Filter-Kits": ["Service Kit","Engine Oil Filter","Airfilter Inner","Airfilter outer","Air Filter Set","Compr Oil Filter","Hydraulic Filter","Water Separator","Fuel Filter","Oil separator","AC Filter"], 
        "Wear-Consumables": ["Ropes","Chain Roller","Chain Link","Sliding Pieces","Slide Bar","Key","Hose Assembly","Belt","Common part"],
        "COP-DHR-Transmission": ["Seal Kit","Up-Box","Drop-Box","Up-Box Overhaul Kit","Drop-Box Overhaul Kit","COP Overhaul Kit Minor","COP Overhaul Kit Major","DHR Overhaul Kit 1000","DHR Overhaul Kit 2000","Rotary Head Overhaul Kit 1000","Rotary Head Overhaul Kit 2000","ARH Repair Kit","Motor","Gearbox Components","Rockdrill Part"],
        "Machine-Parts": ["RHS Part","OSC Valve Block","Damper","Undercarriage","Boom Part","Feed Part","Seal Kit","Pump","Motor","Cabin Parts","Main Valve Block"],
        "Consumables": ["Cotton Waste","Print Paper","Anabond","LocTite","Welding Rods","Fastener","Adapter","Adapter Fittings","Rubber Seals","O-Rings","Bearings"],
        "Electrical and RCS": ["Sensors", "Cables", "Control Module", "Joysticks"], // Updated from placeholders
        "Local Purchase": ["Oil","Hose Assly","Adapter","Fastener","Adapter Fittings","Rubber Seals","O-Rings","Bearings","Seal Part","Common Part","Ropes"] 
    },
    "RockTool": { 
        "Hammer": ["PRISMA-DHD-Hammer 2-3-8 API pin","QL-40 Hammer 2-3-8 API pin","PRISMA 4H Hammer 2-3-8 API pin","PRISMA 4S Hammer 2-3-8 API pin","PRISMA 5-DL-Hammer 2-7-8 API Pin","PRISMA 5.5 Hammer 2-7-8 API Pin","PRISMA 5.5 Hammer 3-1-2 API Pin","P5.5 Hammer with 3-1-2 Beco Pin","PRISMA 6 Hammer 3-1-2 API pin","QL,60 Hammer 3-1-2 API PIN","QL-60 Hammer 3-1-2 BECO PIN"], 
        "Buttonbit": ["PRISMA 4H BIT Quarry","PRISMA 4H BIT HF","Semi Retract Bit 115mm","102mm -Local Vendor","PRISMA 5.5 BIT","Power Retract bit","115mm -Local Vendor","SPHERICAL 127mm","QL60 Button Bit 165mm","K5.5 Bit 152mm","K4 Bit 121mm"],
        "Topsub": ["L8 Mark 2- Fixed Adaptor 6 inch","L8 Mark 2- Float Adaptor 6 inch","Topsub 3-1-2 580mm","Topsub 2-3-8 580mm","Topsub 2-7-8 580mm","Topsub 3-1-2 250mm","Topsub 2-3-8 250mm","Topsub 2-7-8 250mm"],
        "Drillrod": ["T51 Speed Rod","Drill Pipe 89mm 5000mm","Drill Pipe 89mm 6000mm","Drill Pipe 102mm (5000mm)","Drill Pipe 102mm 6000mm","Drill Pipe 114mm 5000mm","Drill Pipe 114mm 6000mm","Drill Pipe 89mm 4000mm","Drill Pipe 102mm 4000mm","Drill Pipe 114mm Terratec","T51 Local Vendor"],
        "Shankadapter": ["T51E- L-770","T51- L-770","T51 Local Vendor","T60- L-840 SECOROC"]
    },
    "Hoses": { 
        "Hydraulic Hoses": ["Tram Hose","Travel Hose","Rotation Hose","Suction Hose","Pilot Hose","RHS Hose","BOT Hose","BOOM Hose","Feeder Hose","Cooler Hose","Tank Hose"], 
        "Compressor Hoses": ["Discharge Hose","Cooler Hose","Air Control Hose"],
        "Engine Hoses": ["Lube Oil Hose","Turbo Hose","Suction Hose"],
        "Other Hoses": ["DCT Hose","HECL Hose","Grease Hose"],
        "Air Hoses": ["DTH1","DTH2","DTH3","DTH4","AP2","Travel Air Hose"],
        "Fuel Hoses": ["Fuel Hose to Filter","Fuel Hose to Pump","Fuel Hose to tank"]
    },
    "UD Parts": { 
    "Boom1": ["Flange Bearing","Bushing","Angle Sensor","Potentio Meter","Cylinder Sealkit","Wire Assly","Protection Coil","DP Checkvalve","Hyd-Hose","Cylinder","Expander Shaft"], 
    "Boom2": ["Flange Bearing","Bushing","Angle Sensor","Potentio Meter","Cylinder Sealkit","Wire Assly","Protection Coil","DP Checkvalve","Hyd-Hose","Cylinder","Expander Shaft"],
    "RockDrill1": ["COP-OH Kit Minor","COP-OH Kit Major","Driver","Diaphragm","Diaphragm Return","Cup Seal","Piston","Damper Piston","Damper Seal","Side Bolt","Dome Nut","Flushing Head","Guide Bush","Piston Guide","Stop Ring"],
    "RockDrill2": ["COP-OH Kit Minor","COP-OH Kit Major","Driver","Diaphragm","Diaphragm Return","Cup Seal","Piston","Damper Piston","Damper Seal","Side Bolt","Dome Nut","Flushing Head","Guide Bush","Piston Guide","Stop Ring"],
    "Feed1": ["Cradle Plate","Sliding Piece","Slide Bar","Dowel","Pull Rope","Return Rope","Roller Bearing","Profile","Front Bushing","Centre Bushing","Hose Drum","Pulley Wheel","Holder","Wiper","Water Hose","Percusssion HP","Percussion-HT","Rotation-RRL","Rotation-RRR","Damping Hose","Lube-Hose","Drain Hose"],
    "Feed2": ["Cradle Plate","Sliding Piece","Slide Bar","Dowel","Pull Rope","Return Rope","Roller Bearing","Profile","Front Bushing","Centre Bushing","Hose Drum","Pulley Wheel","Holder","Wiper","Water Hose","Percusssion HP","Percussion-HT","Rotation-RRL","Rotation-RRR","Damping Hose","Lube-Hose","Drain Hose"]
}
            
};

        const groupToReasons = {
            "Lubricant": ["250 Hr SM","500 Hr SM","1000 Hr SM","1500 Hr SM","2000 Hr SM","Top Up","Leakage","Hose Failure","Contamination"],
            "Parts": ["No Function","Damaged","Maintenance","Worn out","Broken","Leakage","Short Circuit","Open Circuit","No Communication","Welding Defect","Missing"],
            "UD Parts": ["No Function","Damaged","Maintenance","Worn out","Broken","Leakage","Short Circuit","Open Circuit","Hose Burst", "Fitting Leak", "External Rubbing-Damage", "End-of-Life Replacement","No Communication","Welding Defect","Missing"],
            "RockTool": ["Worn out","Broken","Blunt button","Thread Worn","Thread Worn","Dropped in Hole","Jam in hole","shank crack"],
            "Hoses": ["Hose Burst", "Fitting Leak", "External Rubbing-Damage", "End-of-Life Replacement"]
        };

    let partCount = 1;

    window.onload = function() {
        const custSelect = document.getElementById('customerSelect');
        Object.keys(customerToSites).sort().forEach(c => {
            let opt = document.createElement('option'); opt.value = opt.text = c; custSelect.add(opt);
        });
    };

    function updateRowCascades(el) {
        const block = el.closest('.part-block');
        const group = el.value;
        const typeSel = block.querySelector('.type-sel');
        const reasonSel = block.querySelector('.reason-sel');
        typeSel.innerHTML = '<option value="">-- Select Type --</option>';
        reasonSel.innerHTML = '<option value="">-- Select Reason --</option>';
        if (partsData[group]) {
            Object.keys(partsData[group]).forEach(t => {
                let opt = document.createElement('option'); opt.value = opt.text = t; typeSel.add(opt);
            });
        }
        if (groupToReasons[group]) {
            groupToReasons[group].forEach(r => {
                let opt = document.createElement('option'); opt.value = opt.text = r; reasonSel.add(opt);
            });
        }
    }

    function updateRowDesc(el) {
        const block = el.closest('.part-block');
        const group = block.querySelector('.group-sel').value;
        const type = el.value;
        const descSel = block.querySelector('.desc-sel');
        descSel.innerHTML = '<option value="">-- Select Description --</option>';
        if (partsData[group] && partsData[group][type]) {
            partsData[group][type].forEach(d => {
                let opt = document.createElement('option'); opt.value = opt.text = d; descSel.add(opt);
            });
        }
    }

    function addPartLine() {
        if (partCount >= 10) return alert("Limit of 10 parts reached.");
        partCount++;
        const container = document.getElementById('partsContainer');
        const clone = document.getElementById('part-row-1').cloneNode(true);
        clone.id = "part-row-" + partCount;
        clone.querySelector('.part-header').innerText = "PART ENTRY #" + partCount;
        clone.querySelectorAll('select, input').forEach(i => i.value = (i.name === "qty[]" ? 1 : ""));
        
        const removeBtn = document.createElement('button');
        removeBtn.innerText = "Remove Line";
        removeBtn.style = "background:#dc3545; color:white; margin:10px; font-size:12px; padding: 5px 10px;";
        removeBtn.onclick = function() { clone.remove(); partCount--; checkValidation(); };
        clone.appendChild(removeBtn);
        container.appendChild(clone);
        checkValidation();
    }

    function verifyCredentials() {
        const user = document.getElementById('valTech').value.trim();
        const pass = document.getElementById('passInput').value.trim();
        if(!user || !pass) return alert("Enter credentials.");
        document.getElementById('verifyBtn').innerText = "Verifying...";
        fetch(scriptURL + "?action=check&u=" + encodeURIComponent(user) + "&p=" + encodeURIComponent(pass))
        .then(r => r.text())
        .then(text => {
            if (text.startsWith("success")) {
                document.getElementById('protectedContent').classList.remove('hidden');
                document.getElementById('formButtons').classList.remove('hidden');
                document.getElementById('statusLabel').innerText = "‚úÖ Unlocked: " + (text.split(":")[1] || "Site");
                document.getElementById('statusLabel').className = "status-tag unlocked";
                document.getElementById('verifyBtn').style.display = "none";
                document.getElementById('valTech').readOnly = true;
                document.getElementById('passInput').readOnly = true;
            } else { alert("Login Failed."); document.getElementById('verifyBtn').innerText = "Verify & Unlock Form"; }
        });
    }

    function checkValidation() {
    // 1. Define the Core IDs as they appear in your HTML
    const coreFields = ['Customer_Name', 'Work_Site', 'Fleet_ID', 'Entry_Date', 'Engine_Hours', 'Technician_Name', 'Unlock_Password'];
    
    // 2. Check if any core field is empty
    let isInvalid = coreFields.some(id => {
        const el = document.getElementById(id);
        return el ? !el.value.trim() : false;
    });

    // 3. Check Part Rows: Ensure at least the first part row is filled
    // or check all visible part rows
    const partGroups = document.querySelectorAll('select[name="part_group[]"]');
    partGroups.forEach((sel, index) => {
        // We only strictly validate rows that have been "started"
        if (index === 0 && !sel.value) isInvalid = true; 
    });

    // 4. Update Button State
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = isInvalid;
        // Optional: Change opacity so user sees it is disabled
        submitBtn.style.opacity = isInvalid ? "0.5" : "1";
    }
}

// 5. ATTACH LISTENERS: Ensure this runs whenever a user types or selects
document.addEventListener('input', checkValidation);
document.addEventListener('change', checkValidation);

    function updateSites() {
        const customer = document.getElementById('customerSelect').value;
        const siteSelect = document.getElementById('workSiteSelect');
        siteSelect.innerHTML = '<option value="">-- Select Site --</option>';
        if (customerToSites[customer]) {
            customerToSites[customer].forEach(s => {
                let opt = document.createElement('option'); opt.value = opt.text = s; siteSelect.add(opt);
            });
        }
        updateFleet();
    }

    function updateFleet() {
        const site = document.getElementById('workSiteSelect').value;
        const fleetSelect = document.getElementById('fleetSelect');
        fleetSelect.innerHTML = '<option value="">-- Select Fleet --</option>';
        if (siteToFleet[site]) { siteToFleet[site].forEach(f => {
            let opt = document.createElement('option'); opt.value = opt.text = f; fleetSelect.add(opt);
        }); }
    }

    document.getElementById('consumptionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Processing..."; btn.disabled = true;
        const formData = new FormData(this);
        formData.append('Unlock_Password', document.getElementById('passInput').value);
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: formData })
        .then(() => { alert("Success! Records saved."); location.reload(); })
        .catch(() => { alert("Error saving data."); btn.disabled = false; });
    });
   // --- 1. DOWNLOAD TEMPLATE FUNCTION (12 Data Columns) ---
function downloadCSVTemplate() {
    // These 12 headers map to Columns B through M in your Google Sheet
    const headers = [
        "Customer_Name", "Work_Site", "Fleet_ID", 
        "Entry_Date", "Engine_Hours", 
        "Part_Group", "Part_Type", "Part_Description", 
        "Part_Number", "Quantity", "Unit_Price", "Reason_to_Replace"
    ];
    
    const sample = [
        "TATA STEEL LTD", "Noamundi Iron Ore Mines", "SRD65_24005_TSLNIM", 
        "2026-02-14", "4500", 
        "Maintenance", "Filter", "Oil Filter", 
        "EF-100", "2", "550.50", "Routine Service"
    ];
    
    const csvContent = [headers, sample].map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", "PACTRA360_Bulk_Template.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- 1. THE UPLOAD ENGINE (Unified & Balanced) ---
function handleBulkUpload() {
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbybrxbdpNrjPIS6FpjtzQXrUNSokE2yWwmZ0sBaqKyCmOOLeWQSxCAVCN2i_UGtWTLq/exec"; 

    const techName = document.getElementById('valTech').value.trim();
    const techPass = document.getElementById('passInput').value.trim();

    if (!techName || !techPass) {
        alert("‚ö†Ô∏è Please enter User Name and Password first!");
        return;
    }

    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    if (!file) { alert("‚ö†Ô∏è Please select a CSV file first!"); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const rawContent = e.target.result; // For Column P Unique ID
            const rows = rawContent.split(/\r?\n/).slice(1);
            let bulkPayload = [];

            rows.forEach((row) => {
                if (!row.trim()) return;
                const cols = row.split(',');
                if (cols.length >= 12) {
                    bulkPayload.push({
                        Technician_Name: techName,
                        Unlock_Password: techPass,
                        Customer_Name: cols[0].trim(),
                        Work_Site: cols[1].trim(),
                        Fleet_ID: cols[2].trim(),
                        Entry_Date: cols[3].trim(),
                        Engine_Hours: cols[4].trim(),
                        Part_Group: cols[5].trim(),
                        Part_Type: cols[6].trim(),
                        Part_Description: cols[7].trim(),
                        Part_Number: cols[8].trim(),
                        Quantity: cols[9].trim(),
                        Unit_Price: cols[10].trim(),
                        Reason_to_Replace: cols[11].trim()
                    });
                }
            });

            if (bulkPayload.length > 0) {
                if(confirm(`Security Verified for ${techName}. Upload ${bulkPayload.length} records?`)) {
                    const btn = document.querySelector("button[onclick='handleBulkUpload()']");
                    if(btn) { btn.innerText = "‚è≥ Checking Duplicates..."; btn.disabled = true; }

                    // Use google.script.run for duplicate protection (Column P)
                    google.script.run
                        .withSuccessHandler((response) => {
                            alert(response);
                            if(btn) { btn.innerText = "üöÄ Upload & Process Bulk Data"; btn.disabled = false; }
                            if(response.includes("Success")) fileInput.value = "";
                        })
                        .withFailureHandler((err) => {
                            alert("‚ùå Server Error: " + err);
                            if(btn) { btn.innerText = "üöÄ Upload & Process Bulk Data"; btn.disabled = false; }
                        })
                        .processBulkData(bulkPayload, rawContent); 
                }
            }
        } catch (err) {
            alert("‚ùå Processing Error: " + err.message);
        }
    };
    reader.readAsText(file);
}

function generateDynamicTemplate() {
    try {
        var c = (document.getElementById('customerSelect')).value;
        var s = (document.getElementById('workSiteSelect')).value;
        var f = (document.getElementById('fleetSelect')).value;

        if (!c || !s || !f) {
            alert("‚ö†Ô∏è Please select Customer, Site, and Fleet from the dropdowns first!");
            return;
        }

        var headers = "Customer_Name,Work_Site,Fleet_ID,Entry_Date,Engine_Hours,Part_Group,Part_Type,Part_Description,Part_Number,Quantity,Unit_Price,Reason_to_Replace";
        var date = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
        var row = '"' + c + '","' + s + '","' + f + '",' + date + ",,,,,,,,";
        var csvContent = headers + "\n" + row;

        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", "Template_" + s.replace(/\s+/g, '_') + ".csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (err) {
        alert("‚ùå Error: " + err.message);
    }
}

// --- 2. ADMIN & SECURITY SECTION ---
var isAdmin = false;

document.addEventListener('click', function(e) {
    if (e.target.innerText && e.target.innerText.includes("Locked")) {
        if (e.ctrlKey && e.altKey) {
            isAdmin = !isAdmin;
            e.target.innerText = isAdmin ? "Unlocked - Admin Active" : "Locked - Please Verify";
            e.target.style.color = isAdmin ? "green" : "red";
            alert(isAdmin ? "üîì ADMIN UNLOCKED" : "üîí ADMIN LOCKED");
        }
    }
});

window.addEventListener('keydown', function(e) {
    if (isAdmin) return true;
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
        return false;
    }
}, true);

window.addEventListener('contextmenu', function(e) {
    if (!isAdmin) e.preventDefault();
}, true);
</script>
</body>
</html>
